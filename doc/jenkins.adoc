= Jenkins

== Configure Jenkins

=== Plugins

Some plugins are needed for running the pipelines

* Pipeline Utility Steps
+
Used for extracting the pom's project version
* SonarQube Scanner
+
For perfoming source code analysis

=== Configure System

Go to Manage Jenkins -> Configure System

image::jenkins/manage-jenkins.png[Configure system]

=== Configure SonarQube

See https://medium.com/@rosaniline/setup-sonarqube-with-jenkins-declarative-pipeline-75bccdc9075f[this blog]

. SonarQube authentication Token is generated by SonarQube
+
To get the server authentication token, login to SonarQube and go to Administration -> Security -> Users and then click on Tokens.
There, Enter a Token name and click on Generate and copy the token value and paste it in the Jenkins field and then click on “Done”.
+
image::jenkins/sonar-token-1.png[SonarQube token generation]
+
image::jenkins/sonar-token-2.png[SonarQube token generation]
+
image::jenkins/sonar-token-3.png[SonarQube token generation]

. Configure Jenkins SonarQube's plugin
+
image::jenkins/sonar-plugin-config.png[Sonar Plugin config]
+
The authentication token must be saved as a `Secret Text` credential
. Configure SonarQube's scanner
+
Go to Manage Jenkins -> Global Tool Configuration -> SonarQube Scanner -> SonarQube Scanner installations.
+
image::jenkins/sonar-scanner.png[Sonar Scanner config]

=== Global Library

Configure the Global Pipeline Libraries

This is the libraries used for the pipeline. I.e. scripts are located there

image::jenkins/global-pipeline-libraries.png[Library config]
The library name `pipeline-shard` is used in the jenkins file!
So make sure the name is correct.
We stored the lib at: `https://package-repo.mypkfit.com/bitbucket/scm/inf/build-pipeline.git`
We should have some system user for accessing the repository. In the picture, this is my personal login.

=== Configure Git

Git plugin

image::jenkins/git-user-name.png[Adding Git User Name]

== Configure the Pipeline
. Create multi branch pipeline
. Configure branch sources
+
image::jenkins/branch-souces.png[jenkins branch source config]

. Settings xml
+
Add settings.xml as a config file
+
image::jenkins/config-file.png[Config Files]
+
Add a `Maven settings.xml` file type.
Give an Id (e.g. global-settings-xml).
You will need it later on.

. Use the settings.xml file in Jenkins file
+
    configFileProvider([configFile(fileId: 'global-settings-xml', variable: 'MAVEN_SETTINGS_XML')]) {
        sh 'mvn deploy -s $MAVEN_SETTINGS_XML'
    }